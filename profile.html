<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Campus Bite – Student Profile</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: url('https://images.unsplash.com/photo-1503676260728-1c00da094a0b?auto=format&fit=crop&w=1600&q=80') center/cover no-repeat;
      position: relative;
    }

    body::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 0;
    }

    .profile-card {
      position: relative;
      z-index: 1;
      background: rgba(255, 255, 255, 0.95);
      width: 100%;
      max-width: 450px;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      padding: 30px;
      text-align: center;
    }

    h1 {
      color: #ff6a00;
      margin-bottom: 10px;
    }

    .badge {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ff914d;
      margin-bottom: 15px;
    }

    .profile-pic-container {
      position: relative;
      display: inline-block;
      margin-bottom: 15px;
    }

    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #ff914d;
      cursor: pointer;
      transition: 0.3s;
    }

    .profile-pic:hover { opacity: 0.85; }

    #fileInput { display: none; }

    .profile-card input {
      width: 100%;
      padding: 10px 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .profile-card button {
      width: 48%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }

    .save-btn { background: #ff914d; color: white; }
    .save-btn:hover { background: #ff6a00; }

    .logout-btn { background: #f5f5f5; color: #ff6a00; }
    .logout-btn:hover { background: #ffe1cc; }

    .btn-row { display: flex; justify-content: space-between; margin-top: 15px; }

    .back-link {
      display: inline-block;
      margin-top: 20px;
      text-decoration: none;
      color: #ff6a00;
      font-weight: 600;
      transition: 0.3s;
    }
    .back-link:hover { text-decoration: underline; }

    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #ff914d;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 10px;
      position: fixed;
      z-index: 1;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    #toast.show { visibility: visible; opacity: 1; }
  </style>
</head>
<body>

  <div class="profile-card">
    <img src="https://upload.wikimedia.org/wikipedia/en/8/87/Makerere_University_Logo.png" alt="Muni Badge" class="badge" />

    <h1>My Profile</h1>

    <div class="profile-pic-container">
      <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Profile Picture" class="profile-pic" />
      <input type="file" id="fileInput" accept="image/*" />
    </div>

    <input type="text" id="name" placeholder="Full Name" />
    <input type="email" id="email" placeholder="Email (read-only)" readonly />
    <input type="text" id="faculty" placeholder="Faculty" />
    <input type="text" id="course" placeholder="Course" />
    <input type="text" id="hostel" placeholder="Hostel" />

    <div class="btn-row">
      <button class="save-btn" id="saveBtn">Save Changes</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <a href="home.html" class="back-link">← Back to Home</a>
  </div>

  <div id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyATGWLqyjWJUaDXwudubIc_Hvh5yPVDyOI",
      authDomain: "campus-bite-9dbaa.firebaseapp.com",
      projectId: "campus-bite-9dbaa",
      storageBucket: "campus-bite-9dbaa.appspot.com",
      messagingSenderId: "294389261625",
      appId: "1:294389261625:web:095d6e5e7557555f85f4e8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const nameField = document.getElementById("name");
    const emailField = document.getElementById("email");
    const facultyField = document.getElementById("faculty");
    const courseField = document.getElementById("course");
    const hostelField = document.getElementById("hostel");
    const profilePic = document.getElementById("profilePic");
    const fileInput = document.getElementById("fileInput");
    const toast = document.getElementById("toast");

    function showToast(msg) {
      toast.textContent = msg;
      toast.className = "show";
      setTimeout(() => toast.className = toast.className.replace("show", ""), 2000);
    }

    let currentUid = null;

    profilePic.addEventListener("click", () => fileInput.click());

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUid = user.uid;
        emailField.value = user.email;

        const docRef = doc(db, "students", user.uid);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          nameField.value = data.name || "";
          facultyField.value = data.faculty || "";
          courseField.value = data.course || "";
          hostelField.value = data.hostel || "";
          if (data.profilePic) profilePic.src = data.profilePic;
        }
      }
    });

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file || !currentUid) return;

      const storageRef = ref(storage, `profilePics/${currentUid}.jpg`);
      await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(storageRef);

      profilePic.src = downloadURL;
      await setDoc(doc(db, "students", currentUid), { profilePic: downloadURL }, { merge: true });

      showToast("Profile picture updated!");
    });

    document.getElementById("saveBtn").addEventListener("click", async () => {
      if (!currentUid) return;
      const updatedData = {
        name: nameField.value.trim(),
        faculty: facultyField.value.trim(),
        course: courseField.value.trim(),
        hostel: hostelField.value.trim(),
      };
      await setDoc(doc(db, "students", currentUid), updatedData, { merge: true });
      showToast("Profile updated successfully!");
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      showToast("Logging out...");
      setTimeout(() => (window.location.href = "index.html"), 1000);
    });
  </script>
</body>
</html>
