<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Campus Bite ‚Äì Meals & Budget</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<meta name="theme-color" content="#ff914d">

<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins", sans-serif; }
  body { background:#fff8f1; color:#333; }
  header { background:#ff914d; color:#fff; padding:20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
  header h1 { font-size:1.3rem; font-weight:600; }
  header .subtitle { font-size:0.9rem; }

  /* Dropdown Menu */
  .dropdown { position: relative; display: inline-block; }
  .dropbtn { background:#fff; color:#ff914d; border:none; border-radius:8px; padding:8px 16px; cursor:pointer; font-weight:600; transition:0.3s; }
  .dropbtn:hover { background:#ffd6ba; }
  .dropdown-content { display:none; position:absolute; right:0; background:#fff; min-width:200px; box-shadow:0 8px 16px rgba(0,0,0,0.2); z-index:1; border-radius:8px; overflow:hidden; }
  .dropdown-content a { color:#333; padding:12px 16px; text-decoration:none; display:block; }
  .dropdown-content a:hover { background:#ffd6ba; }
  .dropdown:hover .dropdown-content { display:block; }

  .filter-section { padding:15px 20px; display:flex; flex-wrap:wrap; align-items:center; gap:10px; }
  .filter-section label { font-weight:600; }
  .filter-section select { padding:6px 10px; border-radius:6px; border:1px solid #ddd; }

  .meal-section { padding:20px; display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; }
  .meal-card { background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); overflow:hidden; transition:0.3s; }
  .meal-card:hover { transform:scale(1.03); }
  .meal-card img { width:100%; height:150px; object-fit:cover; }
  .meal-info { padding:12px; }
  .meal-info h3 { color:#ff6a00; margin-bottom:6px; font-size:1rem; }
  .meal-info p { font-size:0.88rem; margin-bottom:6px; }

  /* Add to Budget button (original orange) */
  .meal-info .add-btn {
    background:#ff914d; color:#fff; border:none; border-radius:6px;
    padding:6px 12px; cursor:pointer; font-size:0.9rem; margin-top:6px;
  }
  .meal-info .add-btn:hover { background:#ff6a00; }

  .counter { display:flex; align-items:center; gap:8px; margin-top:8px; }
  .counter button { background:#ff914d; color:#fff; border:none; border-radius:6px; padding:4px 10px; cursor:pointer; font-size:0.9rem; }
  .counter button:hover { background:#ff6a00; }
  .counter span { font-weight:600; min-width:24px; text-align:center; }

  .budget-section { background:#fff0e6; padding:20px; text-align:center; border-top:3px solid #ff914d; margin-top:10px; }
  .budget-section h2 { color:#ff6a00; margin-bottom:8px; }
  .budget-section p { font-size:1rem; margin-bottom:8px; }
  .budget-section button { background:#ff914d; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; transition:0.3s; font-size:0.95rem; margin:4px 6px; }
  .budget-section button:hover{ background:#ff6a00; }

  /* Comments */
  .comments-section { padding:20px; background:#fff; margin:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  .comments-section h2 { color:#ff6a00; margin-bottom:10px; }
  #commentsList { margin-bottom:15px; }
  .comment { background:#fff8f1; padding:10px; border-radius:8px; margin-bottom:8px; }
  .comment strong { color:#ff914d; }
  textarea { width:100%; border-radius:8px; border:1px solid #ddd; padding:10px; font-size:0.9rem; margin-bottom:10px; }
  .comment-btn { background:#ff914d; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; }
  .comment-btn:hover { background:#ff6a00; }

  footer { text-align:center; padding:15px; font-size:0.9rem; background:#fff8f1; color:#777; margin-top:20px; }
  @media (max-width:600px) { .meal-section { grid-template-columns:repeat(2,1fr); } }
</style>
</head>
<body>

<header>
  <div>
    <h1 id="welcomeUser">Welcome to Campus Bite üçΩÔ∏è</h1>
    <p class="subtitle">Plan your meals, save your budget.</p>
  </div>
  <div class="dropdown">
    <button class="dropbtn">Options ‚ñæ</button>
    <div class="dropdown-content">
      <a href="profile.html">Profile</a>
      <a href="chat.html">Chat</a>
      <a href="ingredients.html">Ingredients</a>
      <a href="orders.html">Your Orders</a>
      <a href="description.html">Description</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
  </div>
</header>

<section class="filter-section">
  <label for="categoryFilter">Filter by Category:</label>
  <select id="categoryFilter">
    <option value="All">All</option>
    <option value="Breakfast">Breakfast</option>
    <option value="Lunch">Lunch</option>
    <option value="Drink">Drinks</option>
  </select>

  <label for="dayFilter">Filter by Day:</label>
  <select id="dayFilter">
    <option value="All">All Days</option>
    <option value="Monday">Monday</option>
    <option value="Tuesday">Tuesday</option>
    <option value="Wednesday">Wednesday</option>
    <option value="Thursday">Thursday</option>
    <option value="Friday">Friday</option>
    <option value="Saturday">Saturday</option>
    <option value="Sunday">Sunday</option>
  </select>
</section>

<section class="meal-section" id="mealSection"></section>

<section class="budget-section">
  <h2>Budget Plan</h2>
  <p id="budgetTotal">UGX 0</p>
  <button onclick="resetBudget()">Reset Budget</button>
  <button onclick="window.location.href='budget.html'">View Added Items</button>
</section>

<!-- Comments Section -->
<section class="comments-section">
  <h2>Comments üí¨</h2>
  <div id="commentsList"></div>
  <textarea id="commentInput" placeholder="Write your comment..." rows="3"></textarea><br>
  <button class="comment-btn" onclick="postComment()">Post Comment</button>
</section>

<footer>¬© 2025 Campus Bite. All rights reserved.<br>Muni University | Arua Uganda<br>
  <b>For inquiries: +256 748 372 023</b>
</footer>

<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
  // Firebase config (ensure this matches login.html)
  const firebaseConfig = {
    apiKey: "AIzaSyATGWLqyjWJUaDXwudubIc_Hvh5yPVDyOI",
    authDomain: "campus-bite-9dbaa.firebaseapp.com",
    projectId: "campus-bite-9dbaa",
    storageBucket: "campus-bite-9dbaa.appspot.com",
    messagingSenderId: "294389261625",
    appId: "1:294389261625:web:095d6e5f85f4e8"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // State
  let totalBudget = 0;
  let mealCounts = {}; // { mealName: count }
  let currentUserName = "";

  const mealSection = document.getElementById("mealSection");
  const budgetDisplay = document.getElementById("budgetTotal");
  const categoryFilter = document.getElementById("categoryFilter");
  const dayFilter = document.getElementById("dayFilter");
  const commentsList = document.getElementById("commentsList");
  const commentInput = document.getElementById("commentInput");

  // Auth guard + preload cart + greeting
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    try {
      // Greeting
      const doc = await db.collection("students").doc(user.uid).get();
      if (doc.exists) {
        const data = doc.data();
        currentUserName = data.name || "Student";
        document.getElementById("welcomeUser").textContent = `Welcome, ${currentUserName} üçΩÔ∏è`;
      } else {
        document.getElementById("welcomeUser").textContent = "Welcome, Student üçΩÔ∏è";
      }

      // Preload cart counters and total
      const snap = await db.collection("carts").doc(user.uid).collection("items").get();
      totalBudget = 0;
      mealCounts = {};
      snap.forEach(d => {
        const item = d.data();
        mealCounts[item.name] = item.count || 0;
        totalBudget += (item.price || 0) * (item.count || 0);
      });
      budgetDisplay.textContent = "UGX " + totalBudget.toLocaleString();
      renderMeals(categoryFilter.value, dayFilter.value);

      // Live comments listener
      db.collection("comments")
        .orderBy("createdAt", "desc")
        .onSnapshot((csnap) => {
          commentsList.innerHTML = "";
          csnap.forEach(cdoc => {
            const c = cdoc.data();
            const div = document.createElement("div");
            div.className = "comment";
            div.innerHTML = `<strong>${c.userName || "Student"}:</strong> ${c.text}`;
            commentsList.appendChild(div);
          });
        });

    } catch (e) {
      // Fallback: still render meals even if Firestore fetch fails
      renderMeals(categoryFilter.value, dayFilter.value);
    }
  });

  async function logout(){
    await auth.signOut();
    window.location.href = "login.html";
  }

  // Meals data
  const meals = [
    {name:"Mandazi", category:"Breakfast", place:"Campus Canteen", price:500, img:"images/mandazi.png"},
    {name:"Chapati", category:"Breakfast", place:"Campus Canteen", price:500, img:"images/chapati.jpg"},
    {name:"Fried Cassava", category:"Breakfast", place:"Bangri TC", price:100, img:"images/fried cassava.jpg"},
    {name:"Pan Cakes", category:"Breakfast", place:"Bangri TC", price:100, img:"images/pancakes.png"},
    {name:"Samosas", category:"Breakfast", place:"Munisite Market", price:200, img:"images/samosa.jpg"},
    {name:"Boiled Eggs", category:"Breakfast", place:"Campus Canteen", price:500, img:"images/eggs.jpg"},
    {name:"Black Tea", category:"Breakfast", place:"Bangri TC", price:500, img:"images/tea.webp"},
    {name:"Toasted Bread", category:"Breakfast", place:"Desert Breeze", price:1000, img:"images/Bread.jpg"},
    {name:"Vegetable Samosa (A pair)", category:"Breakfast", place:"Desert Breeze", price:1000, img:"images/vegetable.jpg"},
    {name:"Beef Samosa (A pair)", category:"Breakfast", place:"Desert Breeze", price:1000, img:"images/beef.png"},
    {name:"Mandazi (A pair)", category:"Breakfast", place:"Desert Breeze", price:1500, img:"images/mandazi.jpg"},
    {name:"Beef Pie", category:"Breakfast", place:"Desert Breeze", price:4000, img:"images/beef pie.jpg"},
    {name:"Cookies", category:"Breakfast", place:"Desert Breeze", price:3000, img:"images/cookies.webp"},
    {name:"Home fries", category:"Breakfast", place:"Desert Breeze", price:3000, img:"images/fries.jpg"},
    {name:"Baked Beans", category:"Breakfast", place:"Desert Breeze", price:3000, img:"images/beans.jpg"},
    {name:"Egg Rolls (A pair)", category:"Breakfast", place:"Desert Breeze", price:3000, img:"images/egg rolls.jpg"},
    {name:"American Pancake", category:"Breakfast", place:"Desert Breeze", price:4000, img:"images/american.jpg"},

    {name:"Kikomando", category:"Lunch", place:"Campus Canteen", price:1000, img:"images/kikomando.jpg"},
    {name:"Fried Rice", category:"Lunch", place:"Desert Breeze", price:2000, img:"images/rice.webp"},
    {name:"Matooke", category:"Lunch", place:"Bangri TC", price:2000, img:"images/matooke.jpg"},
    {name:"White Rice & Beans", category:"Lunch", place:"Bangri TC", price:2000, img:"images/white rice.jpg"},
    {name:"Anyoya", category:"Lunch", place:"Bangri TC", price:1000, img:"images/anyoya.jpeg"},
    {name:"Chicken/Liver/Goat/Beef Stew", category:"Lunch", place:"Desert Breeze", price:10000, img:"images/chicken stew.jpg"},
    {name:"Chicken/Beef/Fish stew", category:"Lunch", place:"Munisite Restaurant", price:5000, img:"images/stew.webp"},
    {name:"Chicken/Beef Pizza", category:"Lunch", place:"Desert Breeze", price:15000, img:"images/pizza.jpg"},
    {name:"Chicken/Beef/Fish/Beans/G.nuts", category:"Lunch", place:"Bariffa Restaurant", price:6000, img:"images/g.nuts.jpg"},
    {name:"Matooke/Karo/Posho/Sweet Potatoes", category:"Lunch", place:"Bariffa Restaurant", price:3000, img:"images/foods.jpg"},
    {name:"Enyasa/Posho/Yams/Sweet & Irish Potatoes", category:"Lunch", place:"Muni site Restaurant", price:3000, img:"images/enyasa.jpg"},
    {name:"Greens/Peas", category:"Lunch", place:"Bariffa Restaurant", price:1500, img:"images/greens.jpg"},
    {name:"Fruit salad", category:"Lunch", place:"Desert Breeze", price:8000, img:"images/fruit.webp"},

    {name:"English Tea", category:"Breakfast", place:"Desert Breeze", price:5000, img:"images/english.jpg"},
    {name:"Hot Chocolate", category:"Breakfast", place:"Desert Breeze", price:5000, img:"images/chocolate.webp"},

    {name:"Cold Water", category:"Drink", place:"Campus Canteen", price:500, img:"images/nivana.jpg"},
    {name:"Cold sodas", category:"Drink", place:"Campus Canteen", price:1000, img:"images/soda.jpg"},
    {name:"Bongo", category:"Drink", place:"Campus Canteen", price:1000, img:"images/bongo.jpg"},
    {name:"Guiness", category:"Drink", place:"Campus Ark", price:4500, img:"images/guiness.png"},
    {name:"Bond 7", category:"Drink", place:"Campus Ark", price:7500, img:"images/bond7.jpg"},
    {name:"Smirnoff", category:"Drink", place:"Campus Ark", price:4000, img:"images/smirnoff.jpg"},
    {name:"Club Pilsener", category:"Drink", place:"Campus Ark", price:3500, img:"images/club.webp"},
    {name:"Minute maid", category:"Drink", place:"Campus Ark", price:2500, img:"images/minute maid.webp"},
    {name:"Bushera", category:"Drink", place:"Campus Canteen", price:1000, img:"images/bushera.jpeg"},
    {name:"Oner", category:"Drink", place:"Campus Canteen", price:1000, img:"images/oner.jpeg"},
    {name:"Yorghurt", category:"Drink", place:"Campus Canteen", price:2000, img:"images/yorghurt.jpg"},
    {name:"Fresh Juice", category:"Drink", place:"Desert Breeze", price:1000, img:"images/juice.jpg"},

    {name:"Beef Suasage (A pair)", category:"Breakfast", place:"Desert Breeze", price:3000, img:"images/beefs.webp"}
  ];

  function renderMeals(category = "All", day = "All") {
    mealSection.innerHTML = "";
    let allowedPlaces;

    if (["Saturday","Sunday"].includes(day)) {
      allowedPlaces = ["Campus Ark","Campus Canteen","Desert Breeze"];
    } else {
      allowedPlaces = null;
    }

    meals
      .filter(m => (category === "All" || m.category === category))
      .filter(m => !allowedPlaces || allowedPlaces.includes(m.place))
      .forEach(meal => {
        const card = document.createElement("div");
        card.className = "meal-card";
        card.innerHTML = `
          <img src="${meal.img}" alt="${meal.name}">
          <div class="meal-info">
            <h3>${meal.name}</h3>
            <p>${meal.category} ‚Äì UGX ${meal.price.toLocaleString()}</p>
            <p><strong>Place:</strong> ${meal.place}</p>
            <div class="action" data-meal="${meal.name}">
              ${ (mealCounts[meal.name] || 0) > 0
                ? counterHTML(meal.name, meal.price, mealCounts[meal.name])
                : `<button class="add-btn" onclick="addToBudget('${meal.name}', ${meal.price})">Add to Budget</button>`
              }
            </div>
          </div>
        `;
        mealSection.appendChild(card);
      });
  }

  function counterHTML(name, price, count) {
    return `
      <div class="counter" id="counter-${cssSafeId(name)}">
        <button onclick="decrementMeal('${name}', ${price})">-</button>
        <span>${count}</span>
        <button onclick="incrementMeal('${name}', ${price})">+</button>
      </div>
    `;
  }

  function cssSafeId(text){
    return text.replace(/[^a-zA-Z0-9_-]/g, "_");
  }

  categoryFilter.addEventListener("change", () => renderMeals(categoryFilter.value, dayFilter.value));
  dayFilter.addEventListener("change", () => renderMeals(categoryFilter.value, dayFilter.value));

  // Cart operations (Firestore auto-creates)
  function addToBudget(name, amount){
    const user = auth.currentUser;
    if (!user) return alert("You must be logged in!");

    mealCounts[name] = (mealCounts[name] || 0) + 1;
    totalBudget += amount;
    budgetDisplay.textContent = "UGX " + totalBudget.toLocaleString();

    const meal = meals.find(m => m.name === name);
    const itemRef = db.collection("carts").doc(user.uid).collection("items").doc(name);
    itemRef.set({
      name: meal.name,
      price: meal.price,
      img: meal.img,
      place: meal.place,
      count: mealCounts[name]
    }, { merge: true });

    const actionDiv = document.querySelector(`.action[data-meal="${CSS.escape ? CSS.escape(name) : name}"]`);
    if (actionDiv) actionDiv.innerHTML = counterHTML(name, amount, mealCounts[name]);
  }

  function incrementMeal(name, amount){
    const user = auth.currentUser;
    if (!user) return;

    mealCounts[name] = (mealCounts[name] || 0) + 1;
    totalBudget += amount;
    budgetDisplay.textContent = "UGX " + totalBudget.toLocaleString();

    db.collection("carts").doc(user.uid).collection("items").doc(name)
      .set({ count: mealCounts[name] }, { merge: true });

    const counter = document.getElementById(`counter-${cssSafeId(name)}`);
    if (counter) counter.querySelector("span").textContent = mealCounts[name];
  }

  function decrementMeal(name, amount){
    const user = auth.currentUser;
    if (!user) return;

    const current = mealCounts[name] || 0;
    if (current <= 0) return;

    mealCounts[name] = current - 1;
    totalBudget = Math.max(0, totalBudget - amount);
    budgetDisplay.textContent = "UGX " + totalBudget.toLocaleString();

    const itemRef = db.collection("carts").doc(user.uid).collection("items").doc(name);
    if (mealCounts[name] <= 0) {
      itemRef.delete();
      const actionDiv = document.querySelector(`.action[data-meal="${CSS.escape ? CSS.escape(name) : name}"]`);
      if (actionDiv) actionDiv.innerHTML = `<button class="add-btn" onclick="addToBudget('${name}', ${amount})">Add to Budget</button>`;
    } else {
      itemRef.set({ count: mealCounts[name] }, { merge: true });
      const counter = document.getElementById(`counter-${cssSafeId(name)}`);
      if (counter) counter.querySelector("span").textContent = mealCounts[name];
    }
  }

  async function resetBudget(){
    totalBudget = 0;
    mealCounts = {};
    budgetDisplay.textContent = "UGX 0";

    const user = auth.currentUser;
    if (user) {
      const itemsSnap = await db.collection("carts").doc(user.uid).collection("items").get();
      const batch = db.batch();
      itemsSnap.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
    }
    renderMeals(categoryFilter.value, dayFilter.value);
  }

  // Comments
  async function postComment(){
    const user = auth.currentUser;
    if (!user) return alert("You must be logged in to comment.");
    const text = commentInput.value.trim();
    if (!text) return;

    let userName = "Student";
    const userDoc = await db.collection("students").doc(user.uid).get();
    if (userDoc.exists) userName = userDoc.data().name || "Student";

    await db.collection("comments").add({
      userId: user.uid,
      userName: userName,
      text: text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    commentInput.value = "";
  }

  // Initial render
  renderMeals();
</script>

</body>
</html>
