<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Your Budget â€“ Campus Bite</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { background:#fff8f1; font-family:"Poppins", sans-serif; margin:0; padding:0; }
  header { background:#ff914d; color:#fff; padding:15px; text-align:center; font-weight:600; }
  .cart-section { padding:20px; }
  .cart-item { display:flex; align-items:center; background:#fff; margin-bottom:15px; padding:12px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  .cart-item img { width:80px; height:80px; object-fit:cover; border-radius:8px; margin-right:15px; }
  .cart-info { flex:1; }
  .cart-info h3 { margin:0; color:#ff6a00; font-size:1rem; }
  .cart-info p { margin:4px 0; font-size:0.85rem; }
  .counter { display:flex; align-items:center; gap:8px; }
  .counter button { background:#ff914d; color:#fff; border:none; border-radius:6px; padding:4px 10px; cursor:pointer; font-size:0.9rem; }
  .counter button:hover { background:#ff6a00; }
  .counter span { font-weight:600; }
  .total-section { text-align:center; padding:20px; background:#fff0e6; border-top:3px solid #ff914d; }
  .total-section h2 { margin:0; color:#ff6a00; }
  .order-btn, .back-btn { margin-top:15px; background:#ff914d; color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:1rem; }
  .order-btn:hover, .back-btn:hover { background:#ff6a00; }
</style>
</head>
<body>

<header>Your Budget ðŸ›’</header>

<section class="cart-section" id="cartSection"></section>

<section class="total-section">
  <h2 id="totalBudget">Total: UGX 0</h2>
  <button class="order-btn" onclick="makeOrder()">Make Order</button>
  <button class="back-btn" onclick="window.location.href='index.html'">â¬… Back</button>
</section>

<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyATGWLqyjWJUaDXwudubIc_Hvh5yPVDyOI",
    authDomain: "campus-bite-9dbaa.firebaseapp.com",
    projectId: "campus-bite-9dbaa",
    storageBucket: "campus-bite-9dbaa.appspot.com",
    messagingSenderId: "294389261625",
    appId: "1:294389261625:web:095d6e5f85f4e8"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const cartSection = document.getElementById("cartSection");
  const totalBudgetDisplay = document.getElementById("totalBudget");
  let totalBudget = 0;

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
    } else {
      // Listen to cart items in Firestore
      db.collection("carts").doc(user.uid).collection("items").onSnapshot(snapshot => {
        cartSection.innerHTML = "";
        totalBudget = 0;
        snapshot.forEach(doc => {
          const item = doc.data();
          totalBudget += item.price * item.count;

          const div = document.createElement("div");
          div.className = "cart-item";
          div.innerHTML = `
            <img src="${item.img}" alt="${item.name}">
            <div class="cart-info">
              <h3>${item.name}</h3>
              <p>${item.place}</p>
              <p>UGX ${item.price.toLocaleString()}</p>
              <div class="counter">
                <button onclick="updateCount('${doc.id}', ${item.count-1})">-</button>
                <span>${item.count}</span>
                <button onclick="updateCount('${doc.id}', ${item.count+1})">+</button>
              </div>
            </div>
          `;
          cartSection.appendChild(div);
        });
        totalBudgetDisplay.textContent = "Total: UGX " + totalBudget.toLocaleString();
      });
    }
  });

  function updateCount(itemId, newCount){
    const user = auth.currentUser;
    if (!user) return;
    const itemRef = db.collection("carts").doc(user.uid).collection("items").doc(itemId);
    if (newCount <= 0) {
      itemRef.delete();
    } else {
      itemRef.update({ count: newCount });
    }
  }

  async function makeOrder(){
    const user = auth.currentUser;
    if (!user) return;

    const itemsSnap = await db.collection("carts").doc(user.uid).collection("items").get();
    if (itemsSnap.empty) return alert("Your cart is empty!");

    const orderRef = db.collection("orders").doc();
    const batch = db.batch();

    batch.set(orderRef, {
      userId: user.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      total: totalBudget,
      status: "pending"
    });

    itemsSnap.forEach(doc => {
      const item = doc.data();
      const itemRef = orderRef.collection("items").doc(doc.id);
      batch.set(itemRef, item);
    });

    await batch.commit();

    alert("Order placed successfully! ðŸŽ‰");
    // Clear cart after order
    itemsSnap.forEach(doc => doc.ref.delete());
  }
</script>

</body>
</html>
